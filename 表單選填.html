<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>學生志願填寫表單</title>
<style>
body { font-family: Arial; margin: 20px; }
label { display: block; margin-top: 10px; }
select, input { width: 300px; padding: 5px; margin-top: 5px; }
.section { margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; }
button { padding: 10px 20px; margin-top: 10px; }
#message { margin-top: 10px; padding: 10px; border-radius: 5px; }
.success { color: green; background: #f0fff0; border: 1px solid green; }
.error { color: red; background: #fff0f0; border: 1px solid red; }
.info { color: blue; background: #f0f8ff; border: 1px solid blue; }
</style>
</head>
<body>

<h2>學生醫院志願填寫表單</h2>

<form id="volunteerForm">
  <!-- 表單內容保持不變 -->
  <div class="section">
    <label>姓名: <input type="text" name="name" required></label>
    <label>學號: <input type="text" name="studentId" required></label>
    <label>手機號: <input type="text" name="phone" required></label>
    <label>學制:
      <select name="program" required>
        <option value="">請選擇學制</option>
        <option value="日二技">日二技</option>
        <option value="進四技">進四技</option>
        <option value="日四技">日四技</option>
      </select>
    </label>
    <label>是否申請醫院獎學金:
      <select name="scholarship" required>
        <option value="">請選擇</option>
        <option value="是">是</option>
        <option value="否">否</option>
      </select>
    </label>
  </div>

  <div class="section">
    <h3>志願填寫</h3>
    <label>志願一醫院:
      <select name="hospital1" id="hospital1" required></select>
    </label>
    <label>志願一單位:
      <select name="unit1" id="unit1" required></select>
    </label>
    <label>志願二醫院:
      <select name="hospital2" id="hospital2" required></select>
    </label>
    <label>志願二單位:
      <select name="unit2" id="unit2" required></select>
    </label>
  </div>

  <button type="submit">送出表單</button>
</form>

<div id="message" class="info">請填寫表單資料</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyn1rGnMaezs1QAJ5dVQFkDNnO-LxGR_PZjl5EZNqYFDhu_weB6hnGoSCxStS5ISVnKWQ/exec";

// 醫院與對應單位
const hospitals = {
  "醫院A": ["單位A1", "單位A2", "單位A3"],
  "醫院B": ["單位B1", "單位B2"],
  "醫院C": ["單位C1", "單位C2", "單位C3", "單位C4"],
  "醫院D": ["單位D1"]
};

function showMessage(message, type = 'info') {
  const messageDiv = document.getElementById('message');
  messageDiv.textContent = message;
  messageDiv.className = type;
}

// 初始化醫院選單
function populateHospitals() {
  ["hospital1","hospital2"].forEach(id=>{
    const select = document.getElementById(id);
    select.innerHTML = '<option value="">請選擇醫院</option>';
    for(let h in hospitals){
      const opt = document.createElement('option');
      opt.value = h; opt.textContent = h;
      select.appendChild(opt);
    }
  });
}

// 根據選擇醫院更新單位
function updateUnits(hospitalId, unitId){
  const hospital = document.getElementById(hospitalId);
  const unit = document.getElementById(unitId);

  function setOptions(){
    unit.innerHTML = '';
    const h = hospital.value;
    if(!h){
      unit.innerHTML='<option value="">請先選醫院</option>';
      return;
    }
    hospitals[h].forEach(u=>{
      const opt = document.createElement('option');
      opt.value = u; opt.textContent = u;
      unit.appendChild(opt);
    });
  }

  hospital.addEventListener('change', setOptions);
  setOptions();
}

// 使用傳統表單提交 JSON 資料
document.getElementById('volunteerForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const form = this;
  const submitBtn = form.querySelector('button[type="submit"]');
  const data = Object.fromEntries(new FormData(form).entries());
  
  submitBtn.disabled = true;
  submitBtn.textContent = '提交中...';
  showMessage('資料提交中...', 'info');
  
  // 建立隱藏表單來提交 JSON
  const hiddenForm = document.createElement('form');
  hiddenForm.method = 'POST';
  hiddenForm.action = WEBAPP_URL;
  hiddenForm.target = 'hiddenFrame';
  hiddenForm.style.display = 'none';
  
  const dataInput = document.createElement('input');
  dataInput.name = 'data';
  dataInput.value = JSON.stringify(data);
  hiddenForm.appendChild(dataInput);
  
  document.body.appendChild(hiddenForm);
  
  // 建立隱藏 iframe 來接收回應
  const iframe = document.createElement('iframe');
  iframe.name = 'hiddenFrame';
  iframe.style.display = 'none';
  document.body.appendChild(iframe);
  
  iframe.onload = function() {
    // 提交完成後的處理
    showMessage('✅ 表單提交成功！請檢查試算表。', 'success');
    form.reset();
    document.getElementById('unit1').innerHTML = '<option value="">請先選醫院</option>';
    document.getElementById('unit2').innerHTML = '<option value="">請先選醫院</option>';
    
    submitBtn.disabled = false;
    submitBtn.textContent = '送出表單';
    
    // 清理
    document.body.removeChild(hiddenForm);
    document.body.removeChild(iframe);
  };
  
  hiddenForm.submit();
});

// 初始化
populateHospitals();
updateUnits('hospital1','unit1');
updateUnits('hospital2','unit2');
showMessage('✅ 系統就緒，請填寫表單', 'success');
</script>

</body>
</html>
